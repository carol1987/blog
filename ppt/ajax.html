<!doctype html>
<html lang="zh-cn">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <base target="_blank" />
  <title>Ajax</title>
  <link rel="stylesheet" href="./css/default.css">
  <link rel="stylesheet" href="./css/base.css?v=3">
  <link rel="stylesheet" href="./css/app.css?v=3">
  <link rel="stylesheet" href="./css/scrollbar.css">
  <script src="./js/highlight.pack.js"></script>
  <script type="text/javascript">
  hljs.tabReplace = '  ';
  hljs.initHighlightingOnLoad();
  </script>
</head>
<body spellcheck="false" class="ppt">
  <section class="slide slide-cover">
    <h1>Ajax</h1>
    <h2 class="h3">redky@qq.com</h2>
  </section>
  <section class="slide">
    <div class="hd">
      <h1>XMLHttpRequest</h1>
    </div>
    <div class="bd">
      <ul>
        <li>var xhr = new XMLHttpRequest();
        <li>var xhr = new Active( 'Microsoft.XMLHTTP' );
      </ul>
    </div>
  </section>
  <section class="slide">
    <div class="hd">
      <h1>开始建立连接</h1>
    </div>
    <div class="bd">
      <p><code>xhr.open( method, url, async, username, password );</code>
      <ul>
        <li>method: POST/GET/PUT/HEAD..
        <li>url: 接口地址
        <li>async: Boolean 是否为异步; 默认为 Ture.
        <li>username
        <li>password
      </ul>
<pre>
<code class="javascript" contenteditable>
  xhr.open( 'GET', 'http://www.google.com/' );
</code>
</pre>
    </div>
  </section>
  <section class="slide">
    <div class="hd">
      <h1>添加 Head 信息</h1>
    </div>
    <div class="bd">
      <p><code>xhr.setRequestHeader( headerKEY, value );</code>
<pre>
<code class="javascript" contenteditable>
// Content-Type
xhr.setRequestHeader( 'Content-Type', 'text/plain;charset=UTF-8' );

//  自定义
xhr.setRequestHeader( 'X-Requested-With', 'XMLHttpRequest' );

xhr.setRequestHeader( 'X-test', 'a' );
xhr.setRequestHeader( 'X-test', 'b' );
// X-test: a, b
</code>
</pre>
      <div class="toggle">
        <h2>header key list</h2>
        <ul>
          <li>Accept-Charset
          <li>Accept-Encoding
          <li>Access-Control-Request-Headers
          <li>Access-Control-Request-Method
          <li>Connection
          <li>Content-Length
          <li>Cookie
          <li>Cookie2
          <li>Date
          <li>DNT
          <li>Expect
          <li>Host
          <li>Keep-Alive
          <li>Origin
          <li>Referer
          <li>TE
          <li>Trailer
          <li>Transfer-Encoding
          <li>Upgrade
          <li>User-Agent
          <li>Via
        </ul>
      </div>
    </div>
  </section>  
  <section class="slide">
    <div class="hd">
      <h1>设置返回类型</h1>
    </div>
    <div class="bd">
      <p><code>xhr.responseType [ = value;] </code>
      <ul>
        <li>''
        <li>arraybuffer
        <li>blob
        <li>document
        <li>json
        <li>text
      </ul>
    </div>
  </section>
  <section class="slide">
    <div class="hd">
      <h1>是否支持跨域</h1>
    </div>
    <div class="bd">
      <p>需要 server 端配合, 默认配置是 false.
      <p><code>request.withCredentials = false;</code>
    </div>
  </section>
  <section class="slide">
    <div class="hd">
      <h1>设置超时时间和事件</h1>
    </div>
    <div class="bd">
      <p><code>request.timeout = 0;</code>
<pre>
<code class="javascript" contenteditable>
  request.ontimeout = function() {
    request.abort();
  };
</code>
</pre>
    </div>
  </section>
  <section class="slide">
    <div class="hd">
      <h1>绑定回调</h1>
    </div>
    <div class="bd">
      <ul>
        <li>xhr.onloadstart
        <li>xhr.onprogress
        <li>xhr.onload
        <li>xhr.onabort
        <li>xhr.onerror
        <li>xhr.onloadend
        <li>xhr.onreadystatechange
      </ul>
<pre>
<code class="javascript" contenteditable>
xhr.onreadystatechange = function () {
  handle( xhr );
};
// 或.
xhr.onload = function() {
  handle( xhr );
};
</code>
</pre>
    <h2>文件上传进度事件</h2>
    <p><code>xhr.upload;</code>
    <ul>
      <li>xhr.upload.loadstart
      <li>xhr.upload.progress
      <li>xhr.upload.abort
      <li>xhr.upload.error
      <li>xhr.upload.load
      <li>xhr.upload.timeout
      <li>xhr.upload.loadend
    </ul>
<pre>
<code class="javascript" contenteditable>
xhr.uplaod.onprogress = function(e) {
  // lengthCommutable
  // loaded
  // total
};
</code>
</pre>
    <h2>xhr.readyState</h2>
    <ol start="0">
      <li>UNSENT 未初始化   - 还没调用 open 方法
      <li>OPENED 初始化     - 还没调用 Send 方法.
      <li>HEADER_RECEIVED 发送数据   - 拿到 header 信息.
      <li>LOADING 数据发送中 - 已接收部分数据. 响应不全.
      <li>DONE 完成
    </ol>
    <p>可定期检查 header 信息.<code>xhr.getResponseHeader( headerKey ); </code> 一般用于取 server 的时间: <code>xhr.getResponseHeader( 'Date' );</code>
<pre>
<code class="javascript" contenteditable>
function handle( xhr ) {
  // xhr.state
  if ( xhr.readyState === 4 ) {
    var status = xhr.status;
    // http 状态码.
    // 200+ 认为是成功.
    // 304 缓存也认为是成功.
    // request.statusText
    if ( status &gt;= 200 && status &lt; 300 || status == 304 ) {
      success( xhr );
    } else {
      fail();
    }
  }
);
</code>
</pre>
    <h2>请求成功</h2>
    <ul>
      <li>xhr.getAllResponseHeaders()
      <li>xhr.responseText
      <li>xhr.responseXML
      <li>xhr.response
      <li class="toggle">xhr.responseURL
      <li class="toggle">xhr.overrideMimeType( mime );
    </ul>
<pre>
<code class="javascript" contenteditable>
function success( xhr ) {
  var headers = xhr.getAllResponseHeaders();
  // @todo..
  var response = xhr.response || xhr.responseText;
  // @todo..
}
</code>
</pre>
      <h2>请求失败</h2>
      <p>网络异常. 不会再有 xhr.response
    </div>
  </section>
  <section class="slide">
    <div class="hd">
      <h1>发送数据</h1>
    </div>
    <div class="bd">
      <ul>
        <li>xhr.send(); - GET
        <li>xhr.send( data ); - POST
      </ul>
<pre>
<code class="javascript" contenteditable>
var formdata = new FormData( /* form */ );
formdata.append( name, value );
formdata.delete( name );
formdata.get( name );
formdata.getAll( name );
formdata.set( name, value );
formdata.has( name );

// 多文件上传.
fd.append( 'files[]', files[i] );
</code>
</pre>      
    </div>
  </section>  
  <section class="slide">
    <div class="hd">
      <h1>取消请求</h1>
    </div>
    <div class="bd">
      <p>xhr.abort();
    </div>
  </section>
  <section class="slide">
    <div class="hd">
      <h1>参考</h1>
    </div>
    <div class="bd">
      <ul>
        <li><a href="http://xhr.spec.whatwg.org/">http://xhr.spec.whatwg.org/</a>
      </ul>
    </div>
  </section>  
  <section class="slide slide-cover">
    <h1>?</h1>
  </section>
  <nav id="navigator"></nav>
  <nav>
    <a href="#" class="nav-prev" data-id="nav" data-direction="previous"></a>
    <a href="#" class="nav-next" data-id="nav" data-direction="next"></a>
  </nav>
  <script src="./js/event.js"></script>
  <script src="./js/se.js?v=1"></script>
  <script src="./js/hash.js"></script>
  <script src="./js/runcase.js?v=1"></script>
  <script src="./js/ui.js"></script>
  <script src="./js/app.js"></script>
  <script src="./js/auto.slide.js"></script>
</body>
</html>
